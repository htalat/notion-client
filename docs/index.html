<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notion Weekly Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #2d3748;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .week-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }
        
        .week-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e2e8f0;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .week-header:hover {
            background-color: #f7fafc;
            border-radius: 8px;
        }
        
        .week-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2d3748;
        }
        
        .week-date {
            color: #718096;
            font-size: 0.9rem;
        }
        
        .page-count {
            background: #4299e1;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .pages-list {
            list-style: none;
        }
        
        .page-item {
            padding: 16px;
            margin-bottom: 12px;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 4px solid #4299e1;
        }
        
        .page-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        
        .page-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            font-size: 0.85rem;
            color: #718096;
        }
        
        .page-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .page-link {
            color: #4299e1;
            text-decoration: none;
        }
        
        .page-link:hover {
            text-decoration: underline;
        }
        
        .no-pages {
            text-align: center;
            color: #a0aec0;
            font-style: italic;
            padding: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #718096;
        }
        
        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .week-content {
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .week-content.collapsed {
            max-height: 0;
            margin-bottom: 0;
            padding-top: 0;
        }
        
        .collapse-indicator {
            margin-left: 8px;
            font-size: 0.8rem;
            transition: transform 0.3s ease;
        }
        
        .collapse-indicator.collapsed {
            transform: rotate(-90deg);
        }

        @media (max-width: 768px) {
            .week-header {
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }
            
            .page-meta {
                flex-direction: column;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“… Notion Weekly Tracker</h1>
        <div id="loading" class="loading">Loading weekly data...</div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="weeks-container"></div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            API_BASE: 'https://api.htalat.com',
            // For local development, use:
            // API_BASE: 'http://localhost:3000',
        };
        
        async function loadWeeklyData() {
            const container = document.getElementById('weeks-container');
            const loading = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            
            try {
                for (let week = 0; week < 10; week++) {
                    try {
                        const response = await fetch(`${CONFIG.API_BASE}/knowledge-base?weeksAgo=${week}`);
                        if (!response.ok) {
                            console.warn(`Failed to load week ${week}: ${response.statusText}`);
                            continue;
                        }
                        
                        const apiData = await response.json();
                        
                        // Transform API response to match expected format
                        const weekData = {
                            week,
                            weekLabel: getWeekLabel(week),
                            dateRange: apiData.dateRange || generateDateRange(week),
                            pages: apiData.pages || [],
                            totalCount: apiData.totalCount || (apiData.pages ? apiData.pages.length : 0)
                        };
                        
                        renderWeek(weekData, container);
                    } catch (err) {
                        console.warn(`Failed to load week ${week}:`, err);
                    }
                }
                loading.style.display = 'none';
            } catch (error) {
                loading.style.display = 'none';
                errorDiv.style.display = 'block';
                errorDiv.textContent = `Error loading data: ${error.message}`;
            }
        }
        
        function getWeekLabel(weeksAgo) {
            if (weeksAgo === 0) return 'This Week';
            if (weeksAgo === 1) return 'Last Week';
            return `${weeksAgo} Weeks Ago`;
        }
        
        function generateDateRange(weeksAgo) {
            const now = new Date();
            const currentDay = now.getDay();
            const daysToMonday = currentDay === 0 ? 6 : currentDay - 1;
            
            const startOfThisWeek = new Date(now);
            startOfThisWeek.setDate(now.getDate() - daysToMonday);
            startOfThisWeek.setHours(0, 0, 0, 0);
            
            const startOfTargetWeek = new Date(startOfThisWeek);
            startOfTargetWeek.setDate(startOfThisWeek.getDate() - (weeksAgo * 7));
            
            const endOfTargetWeek = new Date(startOfTargetWeek);
            endOfTargetWeek.setDate(startOfTargetWeek.getDate() + 6);
            
            const options = { month: 'short', day: 'numeric', year: 'numeric' };
            return `${startOfTargetWeek.toLocaleDateString('en-US', options)} - ${endOfTargetWeek.toLocaleDateString('en-US', options)}`;
        }
        
        function renderWeek(weekData, container) {
            const section = document.createElement('div');
            section.className = 'week-section';
            
            const weekHeader = document.createElement('div');
            weekHeader.className = 'week-header';
            
            const titleDiv = document.createElement('div');
            const title = document.createElement('h2');
            title.className = 'week-title';
            title.innerHTML = weekData.weekLabel + '<span class="collapse-indicator">â–¼</span>';
            const dateRange = document.createElement('div');
            dateRange.className = 'week-date';
            dateRange.textContent = weekData.dateRange;
            titleDiv.appendChild(title);
            titleDiv.appendChild(dateRange);
            
            const pageCount = document.createElement('span');
            pageCount.className = 'page-count';
            pageCount.textContent = `${weekData.pages.length} page${weekData.pages.length !== 1 ? 's' : ''}`;
            
            weekHeader.appendChild(titleDiv);
            weekHeader.appendChild(pageCount);
            section.appendChild(weekHeader);
            
            // Create content wrapper
            const weekContent = document.createElement('div');
            weekContent.className = 'week-content';
            
            // Default to collapsed for all weeks except "This Week" (week 0)
            const isCollapsed = weekData.week !== 0;
            if (isCollapsed) {
                weekContent.classList.add('collapsed');
                title.querySelector('.collapse-indicator').classList.add('collapsed');
            }
            
            if (weekData.pages.length === 0) {
                const noPages = document.createElement('div');
                noPages.className = 'no-pages';
                noPages.textContent = 'No pages created this week';
                weekContent.appendChild(noPages);
            } else {
                const pagesList = document.createElement('ul');
                pagesList.className = 'pages-list';
                
                weekData.pages.forEach(page => {
                    const item = document.createElement('li');
                    item.className = 'page-item';
                    
                    const title = document.createElement('div');
                    title.className = 'page-title';
                    title.textContent = page.title;
                    
                    const meta = document.createElement('div');
                    meta.className = 'page-meta';
                    
                    const created = document.createElement('span');
                    created.innerHTML = `ðŸ“… Created: ${page.createdTime}`;
                    meta.appendChild(created);
                    
                    if (page.parentInfo) {
                        const parent = document.createElement('span');
                        const icon = page.parentInfo.type === 'database' ? 'ðŸ“Š' : 'ðŸ“„';
                        parent.innerHTML = `${icon} ${page.parentInfo.title}`;
                        meta.appendChild(parent);
                    }
                    
                    if (page.linkProperty) {
                        const link = document.createElement('span');
                        link.innerHTML = `ðŸ”— <a href="${page.linkProperty}" target="_blank" class="page-link">External Link</a>`;
                        meta.appendChild(link);
                    }
                    
                    const pageUrl = document.createElement('span');
                    pageUrl.innerHTML = `ðŸ“„ <a href="${page.url}" target="_blank" class="page-link">Open in Notion</a>`;
                    meta.appendChild(pageUrl);
                    
                    item.appendChild(title);
                    item.appendChild(meta);
                    pagesList.appendChild(item);
                });
                
                weekContent.appendChild(pagesList);
            }
            
            // Add click handler for collapsing
            weekHeader.addEventListener('click', () => {
                const indicator = title.querySelector('.collapse-indicator');
                weekContent.classList.toggle('collapsed');
                indicator.classList.toggle('collapsed');
            });
            
            section.appendChild(weekContent);
            container.appendChild(section);
        }
        
        // Load data when page loads
        loadWeeklyData();
    </script>
</body>
</html>